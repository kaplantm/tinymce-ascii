import { ChangeEventHandler, useEffect, useCallback, useRef, useState } from "react";
import "./App.css";
import TinyEditorView from "./components/TinyEditorView";
import { Editor } from "tinymce";
import { srcToAscii } from "./lib/srcToAscii";
import { textToSrc } from "./lib/textToSrc";

// https://i.giphy.com/3o7btYoGy2JkgrLowE.gif
// https://img.fruugo.com/product/9/90/726763909_max.jpg
function App() {
  // const frame = "data:image/jpeg;base64,/9j/4QkGRXhpZgAATU0AKgAAAAgACwEPAAIAAAAGAAAAkgEQAAIAAAAPAAAAmAESAAMAAAABAAEAAAEaAAUAAAABAAAAqAEbAAUAAAABAAAAsAEoAAMAAAABAAIAAAExAAIAAAAHAAAAuAEyAAIAAAAUAAAAwAE8AAIAAAAPAAAA1AITAAMAAAABAAEAAIdpAAQAAAABAAAA5AAAAABBcHBsZQBpUGhvbmUgMTIgbWluaQAAAAAASAAAAAEAAABIAAAAATE2LjEuMQAAMjAyMzowNTowMSAxMDowMTo1MABpUGhvbmUgMTIgbWluaQAAACSCmgAFAAAAAQAAApqCnQAFAAAAAQAAAqKIIgADAAAAAQACAACIJwADAAAAAQAyAACQAAAHAAAABDAyMzKQAwACAAAAFAAAAqqQBAACAAAAFAAAAr6QEAACAAAABwAAAtKQEQACAAAABwAAAtqQEgACAAAABwAAAuKRAQAHAAAABAECAwCSAQAKAAAAAQAAAuqSAgAFAAAAAQAAAvKSAwAKAAAAAQAAAvqSBAAKAAAAAQAAAwKSBwADAAAAAQAFAACSCQADAAAAAQAQAACSCgAFAAAAAQAAAwqSFAADAAAABAAAAxKSfAAHAAAFiQAAAxqSkQACAAAABDQxOQCSkgACAAAABDQxOQCgAAAHAAAABDAxMDCgAQADAAAAAf//AACgAgAEAAAAAQAAD8CgAwAEAAAAAQAAC9CiFwADAAAAAQACAACjAQAHAAAAAQEAAACkAgADAAAAAQAAAACkAwADAAAAAQAAAACkBQADAAAAAQAaAACkBgADAAAAAQAAAACkMgAFAAAABAAACKSkMwACAAAABgAACMSkNAACAAAAMQAACMqkYAADAAAAAQACAAAAAAAAAAAAAQAAAHkAAAAIAAAABTIwMjM6MDU6MDEgMTA6MDE6NTAAMjAyMzowNTowMSAxMDowMTo1MAAtMDQ6MDAAAC0wNDowMAAALTA0OjAwAAAAATRFAAAshQAAOG8AACmdAACb8gAAH6kAAAAAAAAAAQAAABUAAAAFB9kF3gigBWtBcHBsZSBpT1MAAAFNTQAqAAEACQAAAAEAAAAOAAIABwAAAgAAAAIMAAMABwAAAGgAAAQMAAQACQAAAAEAAAAAAAUACQAAAAEAAACpAAYACQAAAAEAAAC2AAcACQAAAAEAAAABAAgACgAAAAMAAAR0AAwACgAAAAIAAASMAA0ACQAAAAEAAAAnAA4ACQAAAAEAAAAAABAACQAAAAEAAAABABEAAgAAACUAAAScABQACQAAAAEAAAAKABYABwAAAEgAAATBABcAEAAAAAEAAAUJABkACQAAAAEAAAACABoAAgAAAAYAAAURAB8ACQAAAAEAAAAAACAAAgAAACUAAAUXACEACgAAAAEAAAU8ACMACQAAAAIAAAVEACUAEAAAAAEAAAVMACYACQAAAAEAAAADACcACgAAAAEAAAVUACgACQAAAAEAAAACACsAAgAAACUAAAVcAC0ACQAAAAEAABEaAC4ACQAAAAEAAAABAC8ACQAAAAEAAABNADAACgAAAAEAAAWBADMACQAAAAEAABAAADQACQAAAAEAAAAEADUACQAAAAEAAAADADYACQAAAAEAAAs9ADcACQAAAAEAAAAEADoACQAAAAEAAAAEADsACQAAAAEAAAAAADwACQAAAAEAAAAEAD8ACQAAAAEAAAABAEEACQAAAAEAAAAAAEoACQAAAAEAAAACAAAAAAwADQAOAA8AEAATABQAFQAeADcALwBfAEUAPwBZADgADgAOAA8AEAASABUAFwAdADUANwBlAEUAcQBZAFcARQAOABAAEQATABUAFwAaACgATwBQAGcAggBlAGkAXwBKABAAEwAUABYAGAAbACIARgBDAG4AUwBcACkAKgAcADYAEwAWABgAGgAbACQAOQBZAFcAVQAwACoAGgA5ACAAMwAZACEALQA6AEYAUwA8AC8ANgA8AE0APgAzAFQAYQBbADoAQwBHAEsASQAjAAgACAAJAAoACgAvAHsAKgGAAG8APgA9ADEAKQAVAAkADAANAA4ADwAPABUAvQC4AWYATAAXABIADgALAAwADwAjADgAJQAXABIAJwDZAecBqwBcAQ0ADQAQAA8AEwA7AEAAVwBMACYANwBtAAoDDwM0AccAEgARABsAFgAZAesBfwHBAJkAXgCmAPMAYgEtA3wDsAAbABsAsADXAFQBzwFDAksCBwJDAn0A6wCRAioD7wO/Ar8AFwGeAWECowDJA3sCwQM+AogDgwEiApoBTwJuA+sCGwOlAmAB/AIUAtoDOgLWAlgCJAFQAAIBjAFbAfsCogOmA5QCfAG1AcIBDQN3Ai0CigMvAXYC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";
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const tinyEditorRef = useRef<any>(null);
  const [imageSrc, setImageSrc] = useState<string | null>(null);

  console.log("***renderloop", { imageSrc });
  const getUpdatedAscii = useCallback(async () => {
    console.log("*** getUpdatedAscii");
    const ascii = await srcToAscii(imageSrc, canvasRef);

    console.log("***getUpdatedAscii2", { imageSrc, ascii: ascii });
    if (tinyEditorRef.current?.editor && ascii) {
      tinyEditorRef.current.editor.insertContent(ascii);
      setImageSrc(null);
    }
  }, [imageSrc]);

  useEffect(() => {
    console.log("*** useeffect");
    getUpdatedAscii();
  }, [getUpdatedAscii, imageSrc]);

  const onFileChange: ChangeEventHandler<HTMLInputElement> = (event) => {
    const files = event?.target?.files || [];
    const file = files[0];
    setImageSrc(file ? URL.createObjectURL(file) : null);
  };

  const setupTinyEditor = (editor: Editor) => {
    console.log("here");
    editor.ui.registry.addButton("ascii", {
      text: "◕‿◕",
      onAction: async (_) => {
        const selectionObj = tinyEditorRef.current.editor.selection;
        const selectedText = selectionObj.getContent();
        console.log("***selectedText", selectedText);
        if (selectedText) {
          const src = await textToSrc(selectedText);
          console.log("***src", src);
          setImageSrc(src);
        } else {
          fileInputRef?.current?.click();
        }
      },
    });
  };

  return (
    <div>
      <input type="file" onChange={onFileChange} ref={fileInputRef} style={{ display: "none" }} />
      <canvas ref={canvasRef} style={{ display: "none" }} />
      {/* <canvas ref={canvasRef} /> */}
      <TinyEditorView init={{ setup: setupTinyEditor, toolbar: "ascii" }} ref={tinyEditorRef} />
    </div>
  );
}

export default App;
